name: PR Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  # Job 1: PR Validation
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check for conventional commit format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+'; then
            echo "::warning::PR title should follow conventional commit format"
            echo "::warning::Example: feat(engine): add WASM worker pooling"
          fi

          # Check title length
          if [ ${#PR_TITLE} -lt 10 ]; then
            echo "::error::PR title too short (minimum 10 characters)"
            exit 1
          fi

          if [ ${#PR_TITLE} -gt 100 ]; then
            echo "::error::PR title too long (maximum 100 characters)"
            exit 1
          fi

      - name: Validate PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 20 ]; then
            echo "::error::PR description is required and must be at least 20 characters"
            exit 1
          fi

          # Check for required sections
          if ! echo "$PR_BODY" | grep -qi "## Changes"; then
            echo "::warning::PR should include a '## Changes' section"
          fi

          if ! echo "$PR_BODY" | grep -qi "## Testing"; then
            echo "::warning::PR should include a '## Testing' section"
          fi

      - name: Check for breaking changes
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if echo "$PR_TITLE" | grep -qi "BREAKING CHANGE" || echo "$PR_BODY" | grep -qi "BREAKING CHANGE"; then
            echo "::warning::‚ö†Ô∏è This PR contains BREAKING CHANGES - ensure proper documentation and migration guide"
          fi

      - name: Analyze changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          echo "## üìù Changed Files Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count changes by category
          TS_FILES=$(echo "$CHANGED_FILES" | grep -c '\.ts$' || true)
          TSX_FILES=$(echo "$CHANGED_FILES" | grep -c '\.tsx$' || true)
          TEST_FILES=$(echo "$CHANGED_FILES" | grep -c '\.test\.' || true)
          DOCKER_FILES=$(echo "$CHANGED_FILES" | grep -c 'Dockerfile' || true)
          WORKFLOW_FILES=$(echo "$CHANGED_FILES" | grep -c '\.github/workflows' || true)

          echo "- TypeScript files: $TS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- React components: $TSX_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Test files: $TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Docker files: $DOCKER_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow files: $WORKFLOW_FILES" >> $GITHUB_STEP_SUMMARY

          # Check if tests were added for code changes
          CODE_FILES=$((TS_FILES + TSX_FILES))
          if [ $CODE_FILES -gt 0 ] && [ $TEST_FILES -eq 0 ]; then
            echo "::warning::Code changes detected but no test files modified"
          fi

  # Job 2: Docker Test Status Check
  docker-test-status:
    name: Docker Test Status
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
      - name: Wait for Docker tests
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Docker Unit Tests (Node.js)
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 1200  # 20 minutes

      - name: Check Docker test results
        run: |
          echo "## ‚úÖ Docker Tests Status" >> $GITHUB_STEP_SUMMARY
          echo "All Docker tests completed successfully" >> $GITHUB_STEP_SUMMARY

  # Job 3: Code Quality Metrics
  code-quality-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install cloc
        run: sudo apt-get update && sudo apt-get install -y cloc

      - name: Analyze code metrics
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Count lines of code changed
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')

          echo "## üìä Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Added | $ADDITIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Deleted | $DELETIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| Net Change | $((ADDITIONS - DELETIONS)) |" >> $GITHUB_STEP_SUMMARY

          # Check for large PRs
          if [ $ADDITIONS -gt 500 ]; then
            echo "::warning::Large PR detected (>500 lines added) - consider breaking into smaller PRs"
          fi

  # Job 4: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for security issues
        run: |
          if grep -q '"level": "error"' trivy-results.sarif; then
            echo "::error::Security vulnerabilities found - please review"
            exit 1
          else
            echo "‚úÖ No critical security issues found" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 5: Final PR Status
  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [pr-validation, docker-test-status, code-quality-metrics, security-scan]
    if: always()

    steps:
      - name: Generate final status
        run: |
          echo "# üö¶ PR Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Status Checks" >> $GITHUB_STEP_SUMMARY
          echo "- PR Validation: ${{ needs.pr-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Tests: ${{ needs.docker-test-status.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality-metrics.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.pr-validation.result }}" != "success" ] || \
             [ "${{ needs.docker-test-status.result }}" != "success" ] || \
             [ "${{ needs.code-quality-metrics.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "## ‚ùå Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Please address the issues above before merging" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## ‚úÖ Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "This PR meets all quality standards and is ready for review" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ needs.pr-validation.result }}' === 'success' &&
                          '${{ needs.docker-test-status.result }}' === 'success' &&
                          '${{ needs.code-quality-metrics.result }}' === 'success' &&
                          '${{ needs.security-scan.result }}' === 'success';

            const body = status
              ? '‚úÖ **Quality Gate: PASSED**\n\nAll automated checks passed. This PR is ready for review.'
              : '‚ùå **Quality Gate: FAILED**\n\nSome automated checks failed. Please review the workflow output and address the issues.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
