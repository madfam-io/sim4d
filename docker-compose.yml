# =============================================================================
# BREPFLOW (sim4d) - Docker Compose Configuration
# =============================================================================
# Web-first Parametric CAD Application
# Integrates with MADFAM shared infrastructure
# =============================================================================

name: brepflow

services:
  # Studio - Main React CAD application
  studio:
    build:
      context: .
      dockerfile: Dockerfile.studio
    container_name: brepflow-studio
    ports:
      - '5173:5173'
    volumes:
      - ./apps/studio:/app/apps/studio
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/studio/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://localhost:3001
      - VITE_COLLAB_WS_URL=ws://localhost:8081
      # Janua Auth Integration
      - JANUA_ENABLED=true
      - JANUA_JWT_SECRET=dev-shared-janua-secret-32chars!!
      - JANUA_API_URL=http://janua-api:8001
      - ENABLE_MOCK_GEOMETRY=false
      - REQUIRE_REAL_OCCT=true
    networks:
      - madfam-shared-network
    depends_on:
      - collaboration
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:5173']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    command: pnpm --filter @brepflow/studio run dev --host 0.0.0.0

  # Marketing - Landing page
  marketing:
    build:
      context: .
      dockerfile: Dockerfile.marketing
    container_name: brepflow-marketing
    ports:
      - '3040:3000' # Changed to avoid conflict with other marketing sites
    volumes:
      - ./apps/marketing:/app/apps/marketing
      - ./packages:/app/packages
      - /app/node_modules
      - /app/apps/marketing/node_modules
    environment:
      - NODE_ENV=development
    networks:
      - madfam-shared-network
    command: pnpm --filter @brepflow/marketing run dev --host 0.0.0.0

  # Collaboration WebSocket Server
  collaboration:
    build:
      context: .
      dockerfile: Dockerfile.collaboration
    container_name: brepflow-collaboration
    ports:
      - '8081:8080' # Changed to avoid conflict with enclii
    volumes:
      - ./packages/collaboration/dist:/app/packages/collaboration/dist
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - COLLAB_PORT=8080
      - HEARTBEAT_INTERVAL=30000
      - LOCK_TIMEOUT=60000
      - ENABLE_RATE_LIMIT=${ENABLE_RATE_LIMIT:-true}
      - MAX_CONNECTIONS_PER_IP=${MAX_CONNECTIONS_PER_IP:-10}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:5173}
      # Use shared Redis for collaboration sessions
      - REDIS_URL=redis://:redis_dev_password@madfam-redis-shared:6379/6
    networks:
      - madfam-shared-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: node packages/collaboration/dist/server/standalone-server.cjs

# =============================================================================
# SHARED INFRASTRUCTURE NOTE:
# =============================================================================
# This configuration uses the shared PostgreSQL and Redis from:
#   ~/labspace/solarpunk-foundry/ops/local/docker-compose.shared.yml
#
# Redis: madfam-redis-shared:6379/6 (for collaboration sessions)
#
# Start shared infrastructure first:
#   cd ~/labspace/solarpunk-foundry/ops/bin && ./madfam.sh start
# =============================================================================

networks:
  madfam-shared-network:
    external: true
