# =============================================================================
# BREPFLOW (sim4d) - Production Docker Compose
# =============================================================================
# Web-first Parametric CAD production deployment
# Uses shared infrastructure from madfam-infrastructure
# =============================================================================

name: brepflow-production

services:
  # React Studio (Vite SSR)
  studio:
    image: ${DOCKER_REGISTRY:-ghcr.io/madfam-io}/brepflow-studio:${IMAGE_TAG:-latest}
    container_name: brepflow-studio
    ports:
      - '${BREPFLOW_STUDIO_PORT:-5173}:3000'
    environment:
      NODE_ENV: production
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:3001}
      VITE_COLLAB_WS_URL: ${VITE_COLLAB_WS_URL:-wss://collab.brepflow.io}
      JANUA_ENABLED: "true"
      JANUA_JWT_SECRET: ${JANUA_JWT_SECRET}
      JANUA_API_URL: ${JANUA_API_URL:-http://janua-api:8001}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - madfam-shared-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Marketing Landing Page
  marketing:
    image: ${DOCKER_REGISTRY:-ghcr.io/madfam-io}/brepflow-marketing:${IMAGE_TAG:-latest}
    container_name: brepflow-marketing
    ports:
      - '${BREPFLOW_MARKETING_PORT:-3040}:3000'
    environment:
      NODE_ENV: production
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - madfam-shared-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Collaboration WebSocket Server
  collaboration:
    image: ${DOCKER_REGISTRY:-ghcr.io/madfam-io}/brepflow-collaboration:${IMAGE_TAG:-latest}
    container_name: brepflow-collaboration
    ports:
      - '${BREPFLOW_COLLAB_PORT:-8081}:8080'
    environment:
      NODE_ENV: production
      COLLAB_PORT: 8080
      HEARTBEAT_INTERVAL: 30000
      LOCK_TIMEOUT: 60000
      ENABLE_RATE_LIMIT: "true"
      MAX_CONNECTIONS_PER_IP: 10
      CORS_ORIGIN: ${CORS_ORIGIN:-https://studio.brepflow.io}
      REDIS_URL: ${REDIS_URL:-redis://:${REDIS_PASSWORD}@madfam-redis-shared:6379/6}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - madfam-shared-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  madfam-shared-network:
    external: true
