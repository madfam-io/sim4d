FROM node:22.12-bullseye

# Install pnpm
ENV PNPM_HOME=/root/.local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN corepack enable && corepack prepare pnpm@8.6.7 --activate

WORKDIR /app

# Copy workspace configuration
COPY pnpm-workspace.yaml pnpm-lock.yaml package.json ./
COPY turbo.json tsconfig*.json ./

# Copy all packages for workspace resolution
COPY packages ./packages
COPY apps/studio ./apps/studio
COPY config ./config
COPY scripts ./scripts

# Install dependencies
RUN pnpm install --frozen-lockfile

# Build dependencies (types, engine-core, etc.)
RUN pnpm --filter @sim4d/types run build
RUN pnpm --filter @sim4d/schemas run build
RUN pnpm --filter @sim4d/engine-core run build
RUN pnpm --filter @sim4d/engine-occt run build
RUN pnpm --filter @sim4d/nodes-core run build
RUN pnpm --filter @sim4d/viewport run build

EXPOSE 5173

# Development server with hot reload
CMD ["pnpm", "--filter", "@sim4d/studio", "run", "dev", "--host", "0.0.0.0"]
